<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Router-Lite 管理面板 - 登录</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Lora:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link id="remixicon-css" href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages/login.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>AI-Router</h1>
                <span class="version">v0.9.0</span>
            </div>
            
            <!-- 初始化表单（首次设置密码） -->
            <div id="init-form" class="login-form" style="display: none;">
                <h2>初始化管理员账户</h2>
                <p class="form-desc">首次使用，请设置管理员密码</p>
                <form onsubmit="Auth.handleInit(event)">
                    <div class="form-group">
                        <label for="init-password">设置密码</label>
                        <div class="input-wrapper">
                            <i class="ri-lock-line"></i>
                            <input type="password" id="init-password" placeholder="请输入密码（至少6位）" required minlength="6">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="init-password-confirm">确认密码</label>
                        <div class="input-wrapper">
                            <i class="ri-lock-line"></i>
                            <input type="password" id="init-password-confirm" placeholder="请再次输入密码" required minlength="6">
                        </div>
                    </div>
                    <div id="init-error" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <span class="btn-text">设置密码并进入</span>
                        <span class="btn-loading" style="display: none;"><i class="ri-loader-4-line spin"></i></span>
                    </button>
                </form>
            </div>
            
            <!-- 登录表单 -->
            <div id="login-form" class="login-form" style="display: none;">
                <h2>管理面板登录</h2>
                <form onsubmit="Auth.handleLogin(event)">
                    <div class="form-group">
                        <label for="login-password">管理员密码</label>
                        <div class="input-wrapper">
                            <i class="ri-lock-line"></i>
                            <input type="password" id="login-password" placeholder="请输入密码" required>
                        </div>
                    </div>
                    <div id="login-error" class="error-message" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <span class="btn-text">登录</span>
                        <span class="btn-loading" style="display: none;"><i class="ri-loader-4-line spin"></i></span>
                    </button>
                </form>
            </div>
            
            <!-- 加载状态 -->
            <div id="loading-state" class="loading-state">
                <i class="ri-loader-4-line spin"></i>
                <span>正在检查认证状态...</span>
            </div>
        </div>
        
        <div class="login-footer">
            <p>AI-Router-Lite &copy; 2024</p>
        </div>
    </div>

    <script>
        const Auth = {
            async init() {
                try {
                    const response = await fetch('/api/auth/status');
                    const data = await response.json();
                    
                    document.getElementById('loading-state').style.display = 'none';
                    
                    if (!data.initialized) {
                        // 显示初始化表单
                        document.getElementById('init-form').style.display = 'block';
                    } else if (data.authenticated) {
                        // 已登录，跳转到管理面板
                        window.location.href = '/admin/';
                    } else {
                        // 显示登录表单
                        document.getElementById('login-form').style.display = 'block';
                    }
                } catch (error) {
                    console.error('检查认证状态失败:', error);
                    document.getElementById('loading-state').innerHTML = 
                        '<i class="ri-error-warning-line"></i><span>无法连接到服务器</span>';
                }
            },
            
            async handleInit(event) {
                event.preventDefault();
                
                const password = document.getElementById('init-password').value;
                const confirmPassword = document.getElementById('init-password-confirm').value;
                const errorEl = document.getElementById('init-error');
                const btn = event.target.querySelector('button[type="submit"]');
                
                // 验证密码
                if (password !== confirmPassword) {
                    errorEl.textContent = '两次输入的密码不一致';
                    errorEl.style.display = 'block';
                    return;
                }
                
                if (password.length < 6) {
                    errorEl.textContent = '密码长度至少6位';
                    errorEl.style.display = 'block';
                    return;
                }
                
                // 显示加载状态
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.btn-loading').style.display = 'inline-block';
                btn.disabled = true;
                errorEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/auth/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 初始化成功，跳转到管理面板
                        window.location.href = '/admin/';
                    } else {
                        errorEl.textContent = data.detail || '初始化失败';
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    errorEl.textContent = '网络错误，请重试';
                    errorEl.style.display = 'block';
                } finally {
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.btn-loading').style.display = 'none';
                    btn.disabled = false;
                }
            },
            
            async handleLogin(event) {
                event.preventDefault();
                
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                const btn = event.target.querySelector('button[type="submit"]');
                
                // 显示加载状态
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.btn-loading').style.display = 'inline-block';
                btn.disabled = true;
                errorEl.style.display = 'none';
                
                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 登录成功，跳转到管理面板
                        window.location.href = '/admin/';
                    } else {
                        errorEl.textContent = data.detail || '登录失败';
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    errorEl.textContent = '网络错误，请重试';
                    errorEl.style.display = 'block';
                } finally {
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.btn-loading').style.display = 'none';
                    btn.disabled = false;
                }
            }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => Auth.init());
    </script>
</body>
</html>